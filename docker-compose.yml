services:
  # ===========================================================================
  # Sibling databases -- uncomment what you need
  # ===========================================================================

  # postgres:
  #   image: postgis/postgis:16-3.4
  #   ports:
  #     - "5432:5432"
  #   environment:
  #     POSTGRES_USER: dev
  #     POSTGRES_PASSWORD: dev
  #     POSTGRES_DB: dev
  #   volumes:
  #     - pgdata:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U dev"]
  #     interval: 5s
  #     timeout: 5s
  #     retries: 5

  # qdrant:
  #   image: qdrant/qdrant:latest
  #   ports:
  #     - "6333:6333"
  #   volumes:
  #     - qdrantdata:/qdrant/storage

  # clickhouse:
  #   image: clickhouse/clickhouse-server:latest
  #   ports:
  #     - "8123:8123"
  #     - "9000:9000"
  #   volumes:
  #     - clickhousedata:/var/lib/clickhouse

  # ===========================================================================
  # CCW Worker
  # ===========================================================================
  worker:
    build: .
    cap_add:
      - NET_ADMIN
      - NET_RAW
    env_file: .env
    environment:
      - TASK_MODE=${TASK_MODE:-attach}
      - TASK_PROMPT=${TASK_PROMPT:-}
      - REPO_URL=${REPO_URL:-}
      - REPO_NAME=${REPO_NAME:-}
      - MAX_TURNS=${MAX_TURNS:-50}
      - ENABLE_FIREWALL=${ENABLE_FIREWALL:-false}
    volumes:
      - ${SSH_KEY_DIR:-~/.ssh}:/home/dev/.ssh:ro
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "${SSH_PORT:-2222}:22"
    stdin_open: true
    tty: true

# volumes:
#   pgdata:
#   qdrantdata:
#   clickhousedata:
