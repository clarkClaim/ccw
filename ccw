#!/bin/bash
set -euo pipefail

# =============================================================================
# CCW - Claude Code Worker
# Spawn isolated Docker containers running Claude Code in YOLO mode
# =============================================================================

CCW_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CCW_IMAGE="ccw-worker"
CCW_PREFIX="ccw"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

usage() {
    cat <<EOF
${BLUE}CCW - Claude Code Worker${NC}

Usage:
  ccw build                              Build the Docker image
  ccw run <repo-url> "<prompt>"          Clone repo, branch, run Claude, push PR
  ccw new <repo-name> "<prompt>"         Create new repo, scaffold, run Claude
  ccw attach <name>                      tmux attach to running worker
  ccw ssh <name>                         SSH into running worker
  ccw exec <name> "<command>"            Run a command in a worker
  ccw ls                                 List running workers
  ccw logs <name>                        Tail Claude's output
  ccw kill <name>                        Stop and remove a worker
  ccw kill-all                           Stop and remove all workers
  ccw here ["<prompt>"]                   Copy current dir into a container, run Claude
  ccw shell                              Start a worker in attach mode (no task)

Options:
  --firewall          Enable network firewall (restrict outbound)
  --max-turns N       Max Claude turns (default: 50)
  --ssh-port PORT     SSH port mapping (default: auto)
  --follow            Tail logs after starting

Examples:
  ccw build
  ccw run https://github.com/you/repo "Add user authentication with JWT"
  ccw new my-api "Create a FastAPI project with CRUD endpoints"
  ccw shell
  ccw attach my-api
  ccw kill my-api
EOF
    exit 0
}

# Load .env if it exists
load_env() {
    if [ -f "$CCW_DIR/.env" ]; then
        set -a
        source "$CCW_DIR/.env"
        set +a
    else
        echo -e "${YELLOW}WARNING: No .env file found. Copy .env.example to .env and fill in your keys.${NC}"
        exit 1
    fi
}

# Generate a container name from input
make_name() {
    echo "$1" | tr '[:upper:]' '[:lower:]' | sed 's|.*/||' | sed 's/\.git$//' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | cut -c1-30 | sed 's/-$//'
}

# Find a free SSH port
free_port() {
    python3 -c "import socket; s=socket.socket(); s.bind(('',0)); print(s.getsockname()[1]); s.close()"
}

# === Commands ===

cmd_build() {
    echo -e "${BLUE}Building CCW worker image...${NC}"
    docker build -t "$CCW_IMAGE" "$CCW_DIR"
    echo -e "${GREEN}Image built: $CCW_IMAGE${NC}"
}

cmd_run() {
    local repo_url="$1"
    local prompt="$2"
    shift 2

    load_env

    local name="${CCW_PREFIX}-$(make_name "$repo_url")"
    local ssh_port="${SSH_PORT:-$(free_port)}"
    local max_turns="${MAX_TURNS:-50}"
    local firewall="${ENABLE_FIREWALL:-false}"
    local follow=false

    # Parse extra flags
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --firewall) firewall=true; shift ;;
            --max-turns) max_turns="$2"; shift 2 ;;
            --ssh-port) ssh_port="$2"; shift 2 ;;
            --follow) follow=true; shift ;;
            *) shift ;;
        esac
    done

    echo -e "${BLUE}Starting worker: $name${NC}"
    echo "  Repo: $repo_url"
    echo "  SSH:  localhost:$ssh_port"

    docker run -d \
        --name "$name" \
        --cap-add NET_ADMIN \
        --cap-add NET_RAW \
        -e ANTHROPIC_API_KEY="${ANTHROPIC_API_KEY:-}" \
        -e OPENAI_API_KEY="${OPENAI_API_KEY:-}" \
        -e HF_TOKEN="${HF_TOKEN:-}" \
        -e GITHUB_TOKEN="${GITHUB_TOKEN:-}" \
        -e MODAL_TOKEN_ID="${MODAL_TOKEN_ID:-}" \
        -e MODAL_TOKEN_SECRET="${MODAL_TOKEN_SECRET:-}" \
        -e AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID:-}" \
        -e AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY:-}" \
        -e AWS_REGION="${AWS_REGION:-us-east-1}" \
        -e TASK_MODE=existing \
        -e REPO_URL="$repo_url" \
        -e TASK_PROMPT="$prompt" \
        -e MAX_TURNS="$max_turns" \
        -e ENABLE_FIREWALL="$firewall" \
        -v ccw-claude-auth:/home/dev/.claude \
        -v "${HOME}/.ssh:/home/dev/.ssh-mount:ro" \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -p "$ssh_port:22" \
        "$CCW_IMAGE"

    echo -e "${GREEN}Worker started: $name${NC}"
    echo "  Attach: ccw attach $(make_name "$repo_url")"
    echo "  SSH:    ssh -p $ssh_port dev@localhost"
    echo "  Logs:   ccw logs $(make_name "$repo_url")"
    echo "  Kill:   ccw kill $(make_name "$repo_url")"

    if [ "$follow" = true ]; then
        sleep 2
        docker logs -f "$name"
    fi
}

cmd_new() {
    local repo_name="$1"
    local prompt="$2"
    shift 2

    load_env

    local name="${CCW_PREFIX}-$(make_name "$repo_name")"
    local ssh_port="${SSH_PORT:-$(free_port)}"
    local max_turns="${MAX_TURNS:-50}"
    local firewall="${ENABLE_FIREWALL:-false}"
    local follow=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --firewall) firewall=true; shift ;;
            --max-turns) max_turns="$2"; shift 2 ;;
            --ssh-port) ssh_port="$2"; shift 2 ;;
            --follow) follow=true; shift ;;
            *) shift ;;
        esac
    done

    echo -e "${BLUE}Starting new project worker: $name${NC}"
    echo "  Repo: $repo_name"
    echo "  SSH:  localhost:$ssh_port"

    docker run -d \
        --name "$name" \
        --cap-add NET_ADMIN \
        --cap-add NET_RAW \
        -e ANTHROPIC_API_KEY="${ANTHROPIC_API_KEY:-}" \
        -e OPENAI_API_KEY="${OPENAI_API_KEY:-}" \
        -e HF_TOKEN="${HF_TOKEN:-}" \
        -e GITHUB_TOKEN="${GITHUB_TOKEN:-}" \
        -e MODAL_TOKEN_ID="${MODAL_TOKEN_ID:-}" \
        -e MODAL_TOKEN_SECRET="${MODAL_TOKEN_SECRET:-}" \
        -e AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID:-}" \
        -e AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY:-}" \
        -e AWS_REGION="${AWS_REGION:-us-east-1}" \
        -e TASK_MODE=new \
        -e REPO_NAME="$repo_name" \
        -e TASK_PROMPT="$prompt" \
        -e MAX_TURNS="$max_turns" \
        -e ENABLE_FIREWALL="$firewall" \
        -v ccw-claude-auth:/home/dev/.claude \
        -v "${HOME}/.ssh:/home/dev/.ssh-mount:ro" \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -p "$ssh_port:22" \
        "$CCW_IMAGE"

    echo -e "${GREEN}Worker started: $name${NC}"
    echo "  Attach: ccw attach $(make_name "$repo_name")"
    echo "  SSH:    ssh -p $ssh_port dev@localhost"
    echo "  Logs:   ccw logs $(make_name "$repo_name")"

    if [ "$follow" = true ]; then
        sleep 2
        docker logs -f "$name"
    fi
}

cmd_here() {
    local prompt="${1:-}"
    load_env

    local dir_name=$(basename "$(pwd)")
    local name="${CCW_PREFIX}-${dir_name}-$$"
    local ssh_port="$(free_port)"

    echo -e "${BLUE}Starting local worker: $name${NC}"
    echo "  Project: $(pwd)"

    # Create a temp tarball of the current directory (respects .gitignore via git archive)
    local tarball=$(mktemp /tmp/ccw-src-XXXXXX.tar.gz)
    if git rev-parse --is-inside-work-tree &>/dev/null; then
        # Include tracked + untracked (but not ignored) files
        git ls-files -co --exclude-standard -z | xargs -0 tar czf "$tarball"
    else
        tar czf "$tarball" --exclude=node_modules --exclude=.git --exclude=__pycache__ .
    fi

    docker run -it \
        --name "$name" \
        --cap-add NET_ADMIN \
        --cap-add NET_RAW \
        -e ANTHROPIC_API_KEY="${ANTHROPIC_API_KEY:-}" \
        -e GITHUB_TOKEN="${GITHUB_TOKEN:-}" \
        -e TASK_MODE=local \
        -e TASK_PROMPT="$prompt" \
        -v ccw-claude-auth:/home/dev/.claude \
        -v "${HOME}/.ssh:/home/dev/.ssh-mount:ro" \
        -v "$tarball:/tmp/src.tar.gz:ro" \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -p "$ssh_port:22" \
        "$CCW_IMAGE"

    rm -f "$tarball"
}

cmd_shell() {
    load_env

    local name="${CCW_PREFIX}-shell-$$"
    local ssh_port="$(free_port)"

    echo -e "${BLUE}Starting shell worker: $name${NC}"

    docker run -it \
        --name "$name" \
        --cap-add NET_ADMIN \
        --cap-add NET_RAW \
        -e ANTHROPIC_API_KEY="${ANTHROPIC_API_KEY:-}" \
        -e GITHUB_TOKEN="${GITHUB_TOKEN:-}" \
        -e TASK_MODE=attach \
        -v ccw-claude-auth:/home/dev/.claude \
        -v "${HOME}/.ssh:/home/dev/.ssh-mount:ro" \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -p "$ssh_port:22" \
        "$CCW_IMAGE"
}

cmd_attach() {
    local name="${CCW_PREFIX}-$1"
    docker exec -it "$name" tmux attach -t worker 2>/dev/null || \
        docker exec -it "$name" tmux new-session -s worker
}

cmd_ssh() {
    local name="${CCW_PREFIX}-$1"
    local port=$(docker port "$name" 22 2>/dev/null | head -1 | cut -d: -f2)
    if [ -z "$port" ]; then
        echo -e "${RED}Could not find SSH port for $name${NC}"
        exit 1
    fi
    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p "$port" dev@localhost
}

cmd_exec() {
    local name="${CCW_PREFIX}-$1"
    shift
    docker exec -it "$name" "$@"
}

cmd_ls() {
    echo -e "${BLUE}Running CCW workers:${NC}"
    docker ps --filter "name=${CCW_PREFIX}-" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || echo "  (none)"
}

cmd_logs() {
    local name="${CCW_PREFIX}-$1"
    docker exec "$name" tail -f /workspace/claude-output.log 2>/dev/null || \
        docker logs -f "$name"
}

cmd_kill() {
    local name="${CCW_PREFIX}-$1"
    echo -e "${YELLOW}Stopping $name...${NC}"
    docker rm -f "$name" 2>/dev/null || true
    echo -e "${GREEN}Removed $name${NC}"
}

cmd_kill_all() {
    echo -e "${YELLOW}Stopping all CCW workers...${NC}"
    docker ps -aq --filter "name=${CCW_PREFIX}-" | xargs -r docker rm -f 2>/dev/null || true
    echo -e "${GREEN}All workers removed${NC}"
}

# === Main ===

case "${1:-help}" in
    build)      cmd_build ;;
    run)        cmd_run "$2" "$3" "${@:4}" ;;
    new)        cmd_new "$2" "$3" "${@:4}" ;;
    here)       cmd_here "${2:-}" ;;
    shell)      cmd_shell ;;
    attach)     cmd_attach "$2" ;;
    ssh)        cmd_ssh "$2" ;;
    exec)       cmd_exec "$2" "${@:3}" ;;
    ls)         cmd_ls ;;
    logs)       cmd_logs "$2" ;;
    kill)       cmd_kill "$2" ;;
    kill-all)   cmd_kill_all ;;
    help|--help|-h) usage ;;
    *)          echo -e "${RED}Unknown command: $1${NC}"; usage ;;
esac
